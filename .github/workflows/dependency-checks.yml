name: "Dependency Checks"
on:
  push:
    branches:
      - main
  pull_request:

env:
  php_extensions: ""
  default_php: 8.0
  composer_install: "composer install --prefer-dist --no-progress --no-interaction"

jobs:

  composer-require-checker:
    name: "Check for missing dependencies"
    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: actions/checkout@v3

      - name: "Install PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.default_php }}
          ini-values: memory_limit=-1
          extensions: ${{ env.php_extensions }}

      - name: "Get Composer cache directory"
        id: composer-cache
        run: echo "::set-output name=dir::$(composer config cache-dir)"

      - name: "Cache dependencies"
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-${{ env.default_php }}-composer-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: "Install dependencies"
        run: ${{ env.composer_install }}

      - name: "Set global composer bin-dir"
        run: composer global config bin-dir /usr/local/bin

      - name: "Install require checker"
        run: composer global require maglnet/composer-require-checker

      - name: "Check"
        run: /usr/local/bin/composer-require-checker check
